<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>客户端文档 | Mavericks Message Broker</title>
    <meta name="generator" content="VuePress 1.6.0">
    <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?e40f49181a1865ea1b410132419345fa";
              var s = document.getElementsByTagName("script")[0]; 
              s.parentNode.insertBefore(hm, s);
            })();
            </script>
    <meta name="description" content="Finishing is more important than perfecting.">
    <link rel="preload" href="/assets/css/0.styles.a748b10c.css" as="style"><link rel="preload" href="/assets/js/app.3182eedf.js" as="script"><link rel="preload" href="/assets/js/2.c3447483.js" as="script"><link rel="preload" href="/assets/js/11.9a682850.js" as="script"><link rel="prefetch" href="/assets/js/10.13e9cc46.js"><link rel="prefetch" href="/assets/js/12.848ea7c5.js"><link rel="prefetch" href="/assets/js/13.803d5bd3.js"><link rel="prefetch" href="/assets/js/14.e4228ba9.js"><link rel="prefetch" href="/assets/js/15.b485fb99.js"><link rel="prefetch" href="/assets/js/16.7edc12dd.js"><link rel="prefetch" href="/assets/js/3.4feb15c6.js"><link rel="prefetch" href="/assets/js/4.a109d5f2.js"><link rel="prefetch" href="/assets/js/5.f7ef2134.js"><link rel="prefetch" href="/assets/js/6.140a8615.js"><link rel="prefetch" href="/assets/js/7.538f2e64.js"><link rel="prefetch" href="/assets/js/8.1a561311.js"><link rel="prefetch" href="/assets/js/9.39ad65fa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a748b10c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Mavericks Message Broker</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Guide Menu" class="dropdown-title"><span class="title">Guide</span> <span class="arrow down"></span></button> <button type="button" aria-label="Guide Menu" class="mobile-dropdown-title"><span class="title">Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/introduce.html" class="nav-link">
  产品介绍
</a></li><li class="dropdown-item"><!----> <a href="/document/apiClient.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  接入文档
</a></li><li class="dropdown-item"><!----> <a href="/document/design.html" class="nav-link">
  设计文档
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="More Menu" class="dropdown-title"><span class="title">了解更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="More Menu" class="mobile-dropdown-title"><span class="title">了解更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MQTT中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901119" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MQTT协议
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://docs.ejabberd.im/get-started/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Ejabberd
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Guide Menu" class="dropdown-title"><span class="title">Guide</span> <span class="arrow down"></span></button> <button type="button" aria-label="Guide Menu" class="mobile-dropdown-title"><span class="title">Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/introduce.html" class="nav-link">
  产品介绍
</a></li><li class="dropdown-item"><!----> <a href="/document/apiClient.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  接入文档
</a></li><li class="dropdown-item"><!----> <a href="/document/design.html" class="nav-link">
  设计文档
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="More Menu" class="dropdown-title"><span class="title">了解更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="More Menu" class="mobile-dropdown-title"><span class="title">了解更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MQTT中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901119" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MQTT协议
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://docs.ejabberd.im/get-started/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Ejabberd
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/document/introduce.html" class="sidebar-link">介绍</a></li><li><a href="/document/importGuide.html" class="sidebar-link">接入指南</a></li><li><a href="/document/apiServer.html" class="sidebar-link">服务端文档</a></li><li><a href="/document/apiClient.html" aria-current="page" class="active sidebar-link">客户端文档</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/apiClient.html#ios" class="sidebar-link">iOS</a></li><li class="sidebar-sub-header"><a href="/document/apiClient.html#安卓" class="sidebar-link">安卓</a></li><li class="sidebar-sub-header"><a href="/document/apiClient.html#相关文档" class="sidebar-link">相关文档</a></li></ul></li><li><a href="/document/updateLog.html" class="sidebar-link">更新日志</a></li><li><a href="/document/general.html" class="sidebar-link">通用</a></li><li><a href="/document/design.html" class="sidebar-link">设计文档</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="客户端文档"><a href="#客户端文档" class="header-anchor">#</a> 客户端文档</h1> <h2 id="ios"><a href="#ios" class="header-anchor">#</a> iOS</h2> <h3 id="快速集成"><a href="#快速集成" class="header-anchor">#</a> 快速集成</h3> <p>通过Cocoapods集成</p> <ol><li>在Podfile中设置pod源。</li></ol> <div class="language-ruby extra-class"><pre class="language-ruby"><code>source <span class="token string">'https://github.com/uponup/JPSpec.git'</span>
</code></pre></div><ol start="2"><li>在Podfile中添加下面内容。</li></ol> <div class="language-ruby extra-class"><pre class="language-ruby"><code>pod <span class="token string">'MessageBroker'</span>
</code></pre></div><ol start="3"><li>执行<code>pod install</code>。</li></ol> <h3 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h3> <ol><li>导入头文件</li></ol> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token builtin">MessageBroker</span>
</code></pre></div><ol start="2"><li>初始化</li></ol> <blockquote><p>在<code>AppDelegate</code>的<code>func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [:]) -&gt; Bool</code>中，初始化SDK</p></blockquote> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">MavlMessageConfiguration</span><span class="token punctuation">(</span>appid<span class="token punctuation">:</span> <span class="token string">&quot;app-id&quot;</span><span class="token punctuation">,</span> appkey<span class="token punctuation">:</span> <span class="token string">&quot;app-key&quot;</span><span class="token punctuation">,</span> msgKey<span class="token punctuation">:</span> <span class="token string">&quot;mesg-key&quot;</span><span class="token punctuation">)</span>
<span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">initializeSDK</span><span class="token punctuation">(</span>config<span class="token punctuation">:</span> config<span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p><a href="/document/importGuide.html#创建应用">获取AppId、AppKey和MesgKey</a></p></div> <h3 id="push相关"><a href="#push相关" class="header-anchor">#</a> PUSH相关</h3> <ol><li>上传deviceToken</li></ol> <blockquote><p>在<code>AppDelegate</code>的<code>func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data)</code>代理中，设置deviceToken</p></blockquote> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">let</span> pushToken <span class="token operator">=</span> deviceToken<span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span> <span class="token function">String</span><span class="token punctuation">(</span>format<span class="token punctuation">:</span> <span class="token string">&quot;%02.2hhx&quot;</span><span class="token punctuation">,</span> $<span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">joined</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">MavlMessage</span><span class="token punctuation">.</span><span class="token function">setDeviceToken</span><span class="token punctuation">(</span>tokenString<span class="token punctuation">:</span> pushToken<span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>登录<code>MB</code>服务器后，会自动上传DeviceToken</p></div> <h3 id="连接管理"><a href="#连接管理" class="header-anchor">#</a> 连接管理</h3> <ol><li>设置代理</li></ol> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span>delegateMsg <span class="token operator">=</span> <span class="token keyword">self</span>
<span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span>delegateLogin <span class="token operator">=</span> <span class="token keyword">self</span>
</code></pre></div><blockquote><p>设置代理后，需要实现相应的代理方法</p></blockquote> <ol start="2"><li>登录<code>MB</code>服务器</li></ol> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>username</td> <td>String</td> <td>用户登录的im账户</td></tr> <tr><td>password</td> <td>String</td> <td>用户登录im的密码</td></tr></tbody></table> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>userName<span class="token punctuation">:</span> username<span class="token punctuation">,</span> password<span class="token punctuation">:</span> password<span class="token punctuation">)</span>
</code></pre></div><ol start="3"><li>退出登录</li></ol> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ol start="4"><li>处理回调</li></ol> <table><thead><tr><th>协议</th> <th>回调方法</th> <th>说明</th></tr></thead> <tbody><tr><td>MavlMessageDelegate</td> <td>func beginLogin()</td> <td>开始登录</td></tr> <tr><td></td> <td>func loginSuccess()</td> <td>登录成功</td></tr> <tr><td></td> <td>func logout(withError: Error?)</td> <td>退出登录</td></tr></tbody></table> <div class="custom-block danger"><p class="custom-block-title">WARNING</p> <p>异常断开后，如果客户端有重联机制，需要重新订阅好友状态</p></div> <h3 id="群组管理"><a href="#群组管理" class="header-anchor">#</a> 群组管理</h3> <ol><li>设置代理</li></ol> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span>delegateGroup <span class="token operator">=</span> <span class="token keyword">self</span>
</code></pre></div><ol start="2"><li>创建群组</li></ol> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>users</td> <td>Set&lt;String&gt;</td> <td>群组初始成员im_account的数组(应包含自己)</td></tr></tbody></table> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">createAGroup</span><span class="token punctuation">(</span>withUsers<span class="token punctuation">:</span> users<span class="token punctuation">)</span>
</code></pre></div><ol start="3"><li>加入群组
function</li></ol> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>gid</td> <td>String</td> <td>想要加入的群组id</td></tr></tbody></table> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">joinGroup</span><span class="token punctuation">(</span>withGroupId<span class="token punctuation">:</span> gid<span class="token punctuation">)</span>
</code></pre></div><ol start="4"><li>退出群组</li></ol> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>gid</td> <td>String</td> <td>想要退出的群组id</td></tr></tbody></table> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">quitGroup</span><span class="token punctuation">(</span>withGroupId<span class="token punctuation">:</span> gid<span class="token punctuation">)</span>
</code></pre></div><ol start="5"><li>处理回调</li></ol> <table><thead><tr><th>协议</th> <th>回调方法</th> <th>说明</th></tr></thead> <tbody><tr><td>MavlMessageGroupDelegate</td> <td>func createGroupSuccess(groupId gid: String, isLauncher: Bool)</td> <td>群组创建成功，isLauncher为true表示本人创建的群组</td></tr> <tr><td></td> <td>func joinedGroup(groupId gid: String, someone: String)</td> <td>表示someone成功加入群组gid</td></tr> <tr><td></td> <td>func quitGroup(gid: String, error: Error?)</td> <td>表示退出群组gid</td></tr></tbody></table> <h3 id="消息管理"><a href="#消息管理" class="header-anchor">#</a> 消息管理</h3> <ol><li>发送消息 - 单聊</li></ol> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>message</td> <td>String</td> <td>要发送的文本内容</td></tr> <tr><td>toFriend</td> <td>String</td> <td>接收方imAccount</td></tr> <tr><td>localId</td> <td>String</td> <td>消息的本地唯一标识符</td></tr></tbody></table> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token string">&quot;hello, are u ok?&quot;</span><span class="token punctuation">,</span> toFriend<span class="token punctuation">:</span> <span class="token string">&quot;revecer-id&quot;</span><span class="token punctuation">,</span> localId<span class="token punctuation">:</span><span class="token string">&quot;local-id&quot;</span><span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>发送消息 - 群组</li></ol> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>message</td> <td>String</td> <td>要发送的文本内容</td></tr> <tr><td>toGroup</td> <td>String</td> <td>目标群组id</td></tr> <tr><td>localId</td> <td>String</td> <td>消息的本地唯一标识符</td></tr></tbody></table> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token string">&quot;hello, are u ok?&quot;</span><span class="token punctuation">,</span> toGroup<span class="token punctuation">:</span> <span class="token string">&quot;gid&quot;</span><span class="token punctuation">,</span> localId<span class="token punctuation">:</span><span class="token string">&quot;local-id&quot;</span><span class="token punctuation">)</span>
</code></pre></div><ol start="3"><li>发送消息 - VMUC</li></ol> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>message</td> <td>String</td> <td>要发送的文本内容</td></tr> <tr><td>toGroup</td> <td>String</td> <td>目标虚拟群组id</td></tr> <tr><td>localId</td> <td>String</td> <td>消息的本地唯一标识符</td></tr> <tr><td>withFriends</td> <td>Set&lt;String&gt;</td> <td>集合类型，圈子成员列表（包含自己）</td></tr></tbody></table> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token string">&quot;hello, are u ok?&quot;</span><span class="token punctuation">,</span> toGroup<span class="token punctuation">:</span> chatToId<span class="token punctuation">,</span> localId<span class="token punctuation">:</span> localId<span class="token punctuation">,</span> withFriends<span class="token punctuation">:</span> friends<span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>VMUC：虚拟群组，MessageBroker不维护群组信息，而是由业务层管理。</p></div> <ol start="4"><li>获取历史信息</li></ol> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>msgId</td> <td>String</td> <td>message游标，想要获取哪条信息之后的信息</td></tr> <tr><td>from</td> <td>String</td> <td>gid/uid，拉取用户和某个好友的或者在某个群组中的数据</td></tr> <tr><td>type</td> <td>Int</td> <td>要获取群组信息还是个人信息，1:单聊，2:群聊</td></tr> <tr><td>offset</td> <td>Int</td> <td>偏移量，每次请求返回数据的数量</td></tr></tbody></table> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">MavlMessage</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">fetchMessages</span><span class="token punctuation">(</span>msgId<span class="token punctuation">:</span> <span class="token string">'1008'</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> gid<span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> offset<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block danger"><p class="custom-block-title">WARNING</p> <p>生产环境中禁止使用该接口</p></div> <ol start="5"><li>处理回调</li></ol> <table><thead><tr><th>协议</th> <th>回调方法</th> <th>说明</th></tr></thead> <tbody><tr><td>MavlMessageStatusDelegate</td> <td>func mavl(willSend: <code>Mesg</code>)</td> <td>即将发出信息</td></tr> <tr><td></td> <td>func mavl(willResend: Mesg)</td> <td>将要重发的信息（qos&gt;0的时候，会有重发机制）</td></tr> <tr><td></td> <td>func mavl(didRevceived messages: <code>[Mesg]</code>, isLoadMore: <code>Bool</code>)</td> <td>收到信息，如果isLoadMore为true，则说明是从历史信息接口中获取到的信息</td></tr></tbody></table> <div class="custom-block tip"><p class="custom-block-title">提示</p> <ul><li>目前qos默认0，所以此接口目前不会有回调</li> <li>消息发送失败的状态，客户端自行维护。如果在<code>didReceived</code>回调中收到了发出去的信息，说明发送成功了，否则消息状态为发送中或者发送失败。</li></ul></div> <h3 id="状态管理"><a href="#状态管理" class="header-anchor">#</a> 状态管理</h3> <ol><li>监听好友状态</li></ol> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>username</td> <td>String</td> <td>被监听对象的im_account</td></tr></tbody></table> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">StatusQueue</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">checkStatus</span><span class="token punctuation">(</span><span class="token string">&quot;Tom&quot;</span><span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>处理回调</li></ol> <table><thead><tr><th>协议</th> <th>回调方法</th> <th>说明</th></tr></thead> <tbody><tr><td>StatusQueueDelegate</td> <td>func statusQueue(didOfflineUsers: <code>[String]</code>)</td> <td>好友下线的回调</td></tr> <tr><td></td> <td>func statusQueue(didOnline user: <code>String</code>)</td> <td>好友上线的回调</td></tr></tbody></table> <h2 id="安卓"><a href="#安卓" class="header-anchor">#</a> 安卓</h2> <h3 id="快速集成-2"><a href="#快速集成-2" class="header-anchor">#</a> 快速集成</h3> <ol><li>下载android-im-sdk.aar</li> <li>下载成功后，将aar添加到 libs 文件夹下，并在app/build.gradle文件下添加如下代码:</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>repositories <span class="token punctuation">{</span>
   <span class="token function">jcenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   flatDir <span class="token punctuation">{</span>
       dirs <span class="token string">'./libs'</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code>dependencies <span class="token punctuation">{</span>
   implementation <span class="token function">fileTree</span><span class="token punctuation">(</span>dir<span class="token operator">:</span> <span class="token string">'libs'</span><span class="token punctuation">,</span> include<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'*.jar'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token function">implementation</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token string">'android-im-sdk'</span><span class="token punctuation">,</span> ext<span class="token operator">:</span> <span class="token string">'aar'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="初始化sdk"><a href="#初始化sdk" class="header-anchor">#</a> 初始化SDK</h3> <p>在app的Applicarion类的onCreate()方法中添加全局配置，设置App Id,  App Key</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IMGlobalConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IMGlobalConfig</span><span class="token punctuation">.</span><span class="token class-name">IMGlobalConfigBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">setAppId</span><span class="token punctuation">(</span><span class="token string">&quot;xxxx&quot;</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">setAppToken</span><span class="token punctuation">(</span><span class="token string">&quot;xxxx&quot;</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">setDebug</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">IMGlobalConfig</span><span class="token punctuation">.</span><span class="token function">initializeSDK</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p><a href="/document/importGuide.html#创建应用">获取AppId、AppKey和MesgKey</a></p></div> <h3 id="连接管理-2"><a href="#连接管理-2" class="header-anchor">#</a> 连接管理</h3> <blockquote><p>获取登录MB服务的账号信息（username, password），该账号信息是登录客户端的账号管理平台成功后返回的，拿到账号信息登录MB服务，如果该账号信息不存在则创建账号并登录，否则直接登录。</p></blockquote> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>username</td> <td>String</td> <td>用户登录的im账户名</td></tr> <tr><td>password</td> <td>String</td> <td>用户登陆的im账户密码</td></tr></tbody></table> <ol><li>创建连接</li></ol> <ul><li>创建 <code>IMClientConfig</code> 对象，主要配置连接MB的账户信息，以及连接设置，连接设置包含 连接超时时间，心跳时间，是否接收离线消息，掉线后是否自动重新连接等；</li> <li>创建 <code>IMClientConfig</code> 对象成功后通过 <code>IMMessageBroker.createMessageBroker(mContext, config)</code>创建IM客户端对象，该对象创建完成后，可进行MB服务的登录，登出，发送消息等操作；</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IMClientConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IMClientConfig</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;client1&quot;</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;client1&quot;</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">setKeepAlive</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">setTlsConnection</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">setCleanSession</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">setAutomaticReconnect</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">IMMessageBroker</span> client <span class="token operator">=</span> <span class="token class-name">IMMessageBroker</span><span class="token punctuation">.</span><span class="token function">createMessageBroker</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>登录</li></ol> <blockquote><p>登录流程可以通过设置 IMMessageDelegate 监听登录事件</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>client<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>登出</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>client<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="4"><li>回调处理</li></ol> <table><thead><tr><th>class</th> <th>方法</th> <th>说明</th></tr></thead> <tbody><tr><td>IMMessageDelegate</td> <td>loginSuccess()</td> <td>登录MB服务成功</td></tr> <tr><td></td> <td>loginError(Throwable throwable)</td> <td>登录MB服务失败</td></tr> <tr><td></td> <td>logoutSuccess()</td> <td>登出MB服务成功</td></tr> <tr><td></td> <td>logoutError(Throwable throwable)</td> <td>登出MB服务失败</td></tr></tbody></table> <div class="custom-block danger"><p class="custom-block-title">WARNING</p> <p>异常断开后，如果客户端有重联机制，需要重新订阅好友状态</p></div> <h3 id="消息管理-2"><a href="#消息管理-2" class="header-anchor">#</a> 消息管理</h3> <blockquote><p>连接MB服务成功后，用户可以通过client对象进行消息发布，接收。</p></blockquote> <ol><li>发布消息</li></ol> <table><thead><tr><th>参数</th> <th>类型</th> <th>说明</th></tr></thead> <tbody><tr><td>message</td> <td>String</td> <td>要发送的文本内容</td></tr> <tr><td>isToGroup</td> <td>Bool</td> <td>是否是群组信息</td></tr> <tr><td>toId</td> <td>String</td> <td>接收者id，如果是群组信息则为gid，否则为uid</td></tr></tbody></table> <div class="language-java extra-class"><pre class="language-java"><code>client<span class="token punctuation">.</span><span class="token function">sendToMessage</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> client2<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>处理回调</li></ol> <table><thead><tr><th>class</th> <th>方法</th> <th>说明</th></tr></thead> <tbody><tr><td>IMMessageStatusDelegate</td> <td>connectComplete(boolean reconnect, String serverURI)</td> <td>连接MB完成（重新连接上）</td></tr> <tr><td></td> <td>connectionLost(Throwable cause)</td> <td>因为网络等原因断开MB连接（掉线）</td></tr> <tr><td></td> <td>onSendingMessage(IMMessage imMessage)</td> <td>正在发送的消息</td></tr> <tr><td></td> <td>onSendDoneMessage(IMMessage imMessage)</td> <td>消息发送到IM总线</td></tr> <tr><td></td> <td>onReceivedMessage(IMMessage imMessage)</td> <td>接收到IM总线发送的消息</td></tr> <tr><td></td> <td>onSendFailedMessage(IMMessage imMessage, Throwable exception)</td> <td>发送消息失败</td></tr></tbody></table> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>未完待续...</p></div> <h2 id="相关文档"><a href="#相关文档" class="header-anchor">#</a> 相关文档</h2> <ul><li><a href="/document/general.html#常见问题">常见问题</a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/document/apiServer.html" class="prev">
        服务端文档
      </a></span> <span class="next"><a href="/document/updateLog.html">
        更新日志
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3182eedf.js" defer></script><script src="/assets/js/2.c3447483.js" defer></script><script src="/assets/js/11.9a682850.js" defer></script>
  </body>
</html>
