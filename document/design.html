<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基础知识 | Mavericks Message Broker</title>
    <meta name="generator" content="VuePress 1.6.0">
    <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?e40f49181a1865ea1b410132419345fa";
              var s = document.getElementsByTagName("script")[0]; 
              s.parentNode.insertBefore(hm, s);
            })();
            </script>
    <meta name="description" content="Finishing is more important than perfecting.">
    <link rel="preload" href="/assets/css/0.styles.a748b10c.css" as="style"><link rel="preload" href="/assets/js/app.3182eedf.js" as="script"><link rel="preload" href="/assets/js/2.c3447483.js" as="script"><link rel="preload" href="/assets/js/6.140a8615.js" as="script"><link rel="prefetch" href="/assets/js/10.13e9cc46.js"><link rel="prefetch" href="/assets/js/11.9a682850.js"><link rel="prefetch" href="/assets/js/12.848ea7c5.js"><link rel="prefetch" href="/assets/js/13.803d5bd3.js"><link rel="prefetch" href="/assets/js/14.e4228ba9.js"><link rel="prefetch" href="/assets/js/15.b485fb99.js"><link rel="prefetch" href="/assets/js/16.7edc12dd.js"><link rel="prefetch" href="/assets/js/3.4feb15c6.js"><link rel="prefetch" href="/assets/js/4.a109d5f2.js"><link rel="prefetch" href="/assets/js/5.f7ef2134.js"><link rel="prefetch" href="/assets/js/7.538f2e64.js"><link rel="prefetch" href="/assets/js/8.1a561311.js"><link rel="prefetch" href="/assets/js/9.39ad65fa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a748b10c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Mavericks Message Broker</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Guide Menu" class="dropdown-title"><span class="title">Guide</span> <span class="arrow down"></span></button> <button type="button" aria-label="Guide Menu" class="mobile-dropdown-title"><span class="title">Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/introduce.html" class="nav-link">
  产品介绍
</a></li><li class="dropdown-item"><!----> <a href="/document/apiClient.html" class="nav-link">
  接入文档
</a></li><li class="dropdown-item"><!----> <a href="/document/design.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  设计文档
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="More Menu" class="dropdown-title"><span class="title">了解更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="More Menu" class="mobile-dropdown-title"><span class="title">了解更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MQTT中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901119" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MQTT协议
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://docs.ejabberd.im/get-started/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Ejabberd
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Guide Menu" class="dropdown-title"><span class="title">Guide</span> <span class="arrow down"></span></button> <button type="button" aria-label="Guide Menu" class="mobile-dropdown-title"><span class="title">Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/introduce.html" class="nav-link">
  产品介绍
</a></li><li class="dropdown-item"><!----> <a href="/document/apiClient.html" class="nav-link">
  接入文档
</a></li><li class="dropdown-item"><!----> <a href="/document/design.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  设计文档
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="More Menu" class="dropdown-title"><span class="title">了解更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="More Menu" class="mobile-dropdown-title"><span class="title">了解更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://mcxiaoke.gitbooks.io/mqtt-cn/content/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MQTT中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901119" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MQTT协议
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://docs.ejabberd.im/get-started/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Ejabberd
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/document/introduce.html" class="sidebar-link">介绍</a></li><li><a href="/document/importGuide.html" class="sidebar-link">接入指南</a></li><li><a href="/document/apiServer.html" class="sidebar-link">服务端文档</a></li><li><a href="/document/apiClient.html" class="sidebar-link">客户端文档</a></li><li><a href="/document/updateLog.html" class="sidebar-link">更新日志</a></li><li><a href="/document/general.html" class="sidebar-link">通用</a></li><li><a href="/document/design.html" aria-current="page" class="active sidebar-link">设计文档</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/design.html#基础知识" class="sidebar-link">基础知识</a></li><li class="sidebar-sub-header"><a href="/document/design.html#配置登录" class="sidebar-link">配置登录</a></li><li class="sidebar-sub-header"><a href="/document/design.html#群组管理" class="sidebar-link">群组管理</a></li><li class="sidebar-sub-header"><a href="/document/design.html#消息管理" class="sidebar-link">消息管理</a></li><li class="sidebar-sub-header"><a href="/document/design.html#push相关" class="sidebar-link">PUSH相关</a></li><li class="sidebar-sub-header"><a href="/document/design.html#拓展知识" class="sidebar-link">拓展知识</a></li><li class="sidebar-sub-header"><a href="/document/design.html#案例" class="sidebar-link">案例：</a></li><li class="sidebar-sub-header"><a href="/document/design.html#术语" class="sidebar-link">术语：</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="基础知识"><a href="#基础知识" class="header-anchor">#</a> 基础知识</h2> <h3 id="自定义协议规则"><a href="#自定义协议规则" class="header-anchor">#</a> 自定义协议规则</h3> <p>小牛消息总线基于MQTT协议，实现IM功能。我们重新定义了MQTT中的Topic和Payload字段，并对其进行了封装。可将其归纳为三部分：发送、接收和订阅，具体定义规则见下表。</p> <table><thead><tr><th>类型</th> <th>协议规则</th> <th>功能</th> <th>Operation</th> <th>Topic</th> <th>Payload</th></tr></thead> <tbody><tr><td>发送</td> <td>appid/operation/localid/uid</td> <td>发送1v1信息</td> <td>1</td> <td>56/1/0</td> <td>uid</td></tr> <tr><td></td> <td>appid/operation/localid/gid</td> <td>创建群组</td> <td>0</td> <td>56/0/localid/gid</td> <td>text</td></tr> <tr><td></td> <td></td> <td>发送1vN信息</td> <td>2</td> <td>56/2/localid/gid</td> <td>text</td></tr> <tr><td></td> <td></td> <td>virtual group聊天</td> <td>3</td> <td>56/3/localid/gid</td> <td>uid list#消息体</td></tr> <tr><td></td> <td></td> <td>加入群聊</td> <td>201</td> <td>56/201/0/gid</td> <td>-</td></tr> <tr><td></td> <td></td> <td>退出群聊</td> <td>202</td> <td>56/201/0/gid</td> <td>-</td></tr> <tr><td></td> <td></td> <td>上传DeviceToken</td> <td>300</td> <td>56/300/0/gid</td> <td>-</td></tr> <tr><td></td> <td>appid/operation/localid/from/type/cursor/offset</td> <td>拉取历史信息</td> <td>401</td> <td>56/401/0/peter/1/cursor/10</td> <td>-</td></tr> <tr><td>接收</td> <td>appid/1/localid/touid/serverid/fromuid</td> <td>接收信息，根据Operation对信息进行分发</td> <td>-</td> <td>56/1/localid/touid/serverid/fromuid</td> <td>-</td></tr> <tr><td>订阅</td> <td>appid/userstatus/uid/online</td> <td>查看用户在线状态</td> <td>-</td> <td>56/userstatus/uid/online</td> <td>-</td></tr></tbody></table> <blockquote><p>备注：userList按照英文逗号,拼接后，在通过#与消息体连接。
发送virtual group信息的时候，需要在Payload中携带userList，MB会根据userList将该信息分发给不同的用户，适用于有历史群组信息的场景。</p></blockquote> <h3 id="sdk设计"><a href="#sdk设计" class="header-anchor">#</a> SDK设计</h3> <p>小牛消息总线主要实现了消息收发，群组管理，获取历史信息，查看用户状态等功能。通过梳理和归纳，我们将这些功能分别抽象到三个接口（协议）中来实现。</p> <h4 id="mavlmessageclient"><a href="#mavlmessageclient" class="header-anchor">#</a> MavlMessageClient</h4> <div class="language- extra-class"><pre><code>主要负责IM相关功能。
</code></pre></div><h4 id="mavlmessageclientstatus"><a href="#mavlmessageclientstatus" class="header-anchor">#</a> MavlMessageClientStatus</h4> <div class="language- extra-class"><pre><code>主要负责通过pub/sub实现的相关功能，例如用户在线状态，个性化信息等。
</code></pre></div><h4 id="mavlmessageclientconfig"><a href="#mavlmessageclientconfig" class="header-anchor">#</a> MavlMessageClientConfig</h4> <div class="language- extra-class"><pre><code>主要负责配置信息上报的相关功能，例如上传DeviceToken，上传DeviceInfo等。
</code></pre></div><p>实现了以上功能，我们还缺少一些必要的回调供给业务方调用，完成业务需求。在IM的业务场景下，我们同样抽象了三个协议，屏蔽掉实现细节，让业务方可以专注于自己的业务需求，而不是MQTT相关的实现。</p> <h4 id="mavlmessagegroupdelegate"><a href="#mavlmessagegroupdelegate" class="header-anchor">#</a> MavlMessageGroupDelegate</h4> <div class="language- extra-class"><pre><code>群组管理，好友管理相关回调，主要方法有：创建群组成功、加入群组成功、退出群组成功、添加好友成功、yan好友在线状态等。
</code></pre></div><h4 id="mavlmessagedelegate"><a href="#mavlmessagedelegate" class="header-anchor">#</a> MavlMessageDelegate</h4> <div class="language- extra-class"><pre><code>用户登录相关回调，主要方法有：开始登录，登录成功，登录失败等。
</code></pre></div><h4 id="mavlmessagestatusdelegate"><a href="#mavlmessagestatusdelegate" class="header-anchor">#</a> MavlMessageStatusDelegate</h4> <div class="language- extra-class"><pre><code>消息状态相关回调，主要方法有：将要发送消息，已经发送消息，收到消息等。
</code></pre></div><h3 id="sdk类图"><a href="#sdk类图" class="header-anchor">#</a> SDK类图</h3> <h2 id="配置登录"><a href="#配置登录" class="header-anchor">#</a> 配置登录</h2> <h3 id="初始化sdk"><a href="#初始化sdk" class="header-anchor">#</a> 初始化SDK：</h3> <p>MB SDK实现逻辑：实例化对象，将appID，appKey传递给SDK持有。</p> <table><thead><tr><th>参数</th> <th>类型</th> <th>定义</th></tr></thead> <tbody><tr><td>appID</td> <td>unsigned int</td> <td>消息平台分发给App的唯一标识符</td></tr> <tr><td>appKey</td> <td>String</td> <td>消息平台分发给App的密钥</td></tr> <tr><td>msgKey</td> <td>String</td> <td>消息加密算法的key</td></tr></tbody></table> <h3 id="登录-与mb建立长连接"><a href="#登录-与mb建立长连接" class="header-anchor">#</a> 登录，与MB建立长连接：</h3> <p>MB SDK实现逻辑：根据协议定义，生成对应参数，调用MQTT SDK登录MB服务器。</p> <table><thead><tr><th>参数</th> <th>类型</th> <th>定义</th></tr></thead> <tbody><tr><td>userID</td> <td>String</td> <td>用户登录MB服务器的id</td></tr> <tr><td>userToken</td> <td>String</td> <td>用户登录MB服务器的密码</td></tr></tbody></table> <blockquote><p>⚠️注意:  用户userID忽略大小写；
MQTT SDK需要开启ssl校验，但是本地不校验证书；</p></blockquote> <h3 id="退出登录"><a href="#退出登录" class="header-anchor">#</a> 退出登录：</h3> <p>MB SDK实现逻辑：调用MQTT SDK disconnect方法，断开与MB服务器的长连接</p> <h2 id="群组管理"><a href="#群组管理" class="header-anchor">#</a> 群组管理</h2> <h3 id="创建群"><a href="#创建群" class="header-anchor">#</a> 创建群</h3> <p>MB SDK实现逻辑：根据协议规则，Operation为0，生成相应的Topic。将userList中的用户id拼接按照appid_uid的格式成字符串作为Payload。然后调用MQTT SDK，将Payload信息Pub到对应的创建群组的Topic。</p> <table><thead><tr><th>参数</th> <th>类型</th> <th>定义</th></tr></thead> <tbody><tr><td>usersList</td> <td>Set</td> <td>群初始成员列表</td></tr></tbody></table> <div class="custom-block warning"><p class="custom-block-title">提示</p> <p>好友列表不可以重复</p></div> <h3 id="加入群-退出群"><a href="#加入群-退出群" class="header-anchor">#</a> 加入群/退出群</h3> <p>MB SDK实现逻辑：加入群Operation为201，退出群Operation为202，生成相应的Topic，调用MQTT SDK，Pub一个空信息给该Topic。</p> <table><thead><tr><th>参数</th> <th>类型</th> <th>定义</th></tr></thead> <tbody><tr><td>groupID</td> <td>String</td> <td>要加入的群组的id</td></tr></tbody></table> <h3 id="好友状态"><a href="#好友状态" class="header-anchor">#</a> 好友状态</h3> <p>MB SDK实现逻辑：每个用户online或者offline的时候，MB会对所有订阅了appid/userstatus/uid/online 的用户发布状态信息，我们提供了观察好友在线状态的接口，以供业务方在合适的时机调用。</p> <table><thead><tr><th>参数</th> <th>类型</th> <th>定义</th></tr></thead> <tbody><tr><td>uid</td> <td>String</td> <td>要观察的用户id</td></tr></tbody></table> <h2 id="消息管理"><a href="#消息管理" class="header-anchor">#</a> 消息管理</h2> <p>我们在接收和发送消息的时候，必不可少地需要消息的一些状态、类型。下图是结合单聊、群组和vmuc三种消息类型，整理出来的消息处理逻辑表。表格中<code>Mesg数据模型部分字段</code>是在设计SDK中消息模型的时候，必须包含的几个字段。
<img src="/assets/img/msg_logic.bc60efe5.png" alt="消息逻辑"></p> <h3 id="发送消息"><a href="#发送消息" class="header-anchor">#</a> 发送消息</h3> <p>MB SDK实现逻辑：发送信息可以细分为1v1消息，1vN消息，虚拟群组信息，分别对应不同的Operation。参考协议规则，将消息Pub到相应的Topic。</p> <table><thead><tr><th>参数</th> <th>类型</th> <th>定义</th></tr></thead> <tbody><tr><td>groupID（可选）</td> <td>String</td> <td>发送1vN信息时，接收的群组id</td></tr> <tr><td>userList（可选）</td> <td>Set</td> <td>发送virtual群组信息时候，群组成员的信息（包含自己）</td></tr> <tr><td>uid（可选）</td> <td>String</td> <td>发送1v1信息的，接收人id</td></tr></tbody></table> <div class="custom-block warning"><p class="custom-block-title">提示</p> <p>userList中的成员不可以重复，所以此处采用了集合的数据类型，可以省去查重的步骤。</p></div> <h3 id="获取历史信息"><a href="#获取历史信息" class="header-anchor">#</a> 获取历史信息</h3> <p>MB SDK实现逻辑：消息总线提供接口供我们获取一段时间内（7天）的历史数据，对应Operation为401。我们可以采用分页请求的方式，拉取7天内的数据。</p> <table><thead><tr><th>参数</th> <th>类型</th> <th>定义</th></tr></thead> <tbody><tr><td>from</td> <td>String</td> <td>gid/uid，拉取用户和某个好友的或者在某个群组中的数据</td></tr> <tr><td>type</td> <td>String</td> <td>要获取群组信息还是个人信息，1:单聊，2:群聊</td></tr> <tr><td>cursor</td> <td>String</td> <td>发送1v1信息的，接收人id</td></tr> <tr><td>offset</td> <td>Int</td> <td>偏移量，一次请求要拉取的消息条数</td></tr></tbody></table> <h3 id="多媒体消息"><a href="#多媒体消息" class="header-anchor">#</a> 多媒体消息</h3> <p>在<code>MB</code>中我们还支持了多媒体消息的收发。但是我们不保存资源，业务层使用的时候，只需要把资源的url传给SDK。多媒体消息类型以及数据格式如下表：</p> <table><thead><tr><th style="text-align:center;">消息类型</th> <th style="text-align:center;">协议类型</th> <th style="text-align:center;">消息内容</th> <th>样例</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">文本消息</td> <td style="text-align:center;">sms://</td> <td style="text-align:center;">msg</td> <td>sms://hello world</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">图片消息</td> <td style="text-align:center;">image://</td> <td style="text-align:center;">url</td> <td>image://http://file1.com/AB...CD.png</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">视频消息</td> <td style="text-align:center;">video://</td> <td style="text-align:center;">url</td> <td>video://http://file1.com/AB...CD.mp4</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">音频消息</td> <td style="text-align:center;">audio://</td> <td style="text-align:center;">url</td> <td>audio://http://file1.com/AB...CD.mp3</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">文件消息</td> <td style="text-align:center;">file://</td> <td style="text-align:center;">url</td> <td>file://http://file1.com/AB...CD.txt</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">位置消息</td> <td style="text-align:center;">location://</td> <td style="text-align:center;">url</td> <td>location://location?lantitude=118&amp;longitude=38</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">富文本消息</td> <td style="text-align:center;">richtext://</td> <td style="text-align:center;">richtext</td> <td>richtext://hello world &lt;image src=&quot;./china.png&quot;&gt;</td> <td style="text-align:center;">暂不实现</td></tr></tbody></table> <h4 id="_1-发送步骤"><a href="#_1-发送步骤" class="header-anchor">#</a> 1. 发送步骤</h4> <p>发送多媒体消息，分为以下几个步骤：</p> <ul><li>上传资源到文件服务器（<code>客户端自行处理</code>，SDK只需要接收资源url）</li> <li>客户端发送消息API，SDK按照协议规定创建多媒体消息，利用mqtt，将消息发出去。</li> <li>收到消息的时候，SDK需要对消息内容解析，然后将解析后的消息实体返回给客户端。</li></ul> <div class="custom-block danger"><p class="custom-block-title">强制要求</p> <p>SDK在实现多媒体消息解析的时候，根据URL解析<code>protocol://host:port/path?query</code>来获取多媒体消息的内容和参数。不可以利用特殊字符串自行处理。</p></div> <h4 id="_2-接口定义"><a href="#_2-接口定义" class="header-anchor">#</a> 2. 接口定义</h4> <p>在目前发送消息接口上新增发送多媒体消息的接口，传入<code>MultiMedia</code>类型的参数</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function">send</span><span class="token punctuation">(</span>mediaMesg msg<span class="token punctuation">:</span> <span class="token builtin">MultiMedia</span><span class="token punctuation">,</span> toFriend fid<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> localId<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">send</span><span class="token punctuation">(</span>mediaMesg msg<span class="token punctuation">:</span> <span class="token builtin">MultiMedia</span><span class="token punctuation">,</span> toGroup gid<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> localId<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> withFriends fids<span class="token punctuation">:</span> <span class="token builtin">Set</span><span class="token operator">&lt;</span><span class="token builtin">String</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">提示</p> <p>原SDK中发送文本消息的接口，不必再单独实现发送逻辑，重载上面两个方法即可</p></div> <p>MultiMedia数据模型如下：</p> <table><thead><tr><th>字段名</th> <th>type</th> <th>url</th></tr></thead> <tbody><tr><td>类型</td> <td>enum</td> <td>string</td></tr> <tr><td>含义</td> <td>消息类型</td> <td>消息内容</td></tr></tbody></table> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>type为枚举类型，不建议用字符串或者数字代替。理由是，这个接口面向用户，如果是enum的话，客户端传进来的参数是可控的，如果用其他类型，我们还需要考虑非法类型的问题。</p></div> <h2 id="push相关"><a href="#push相关" class="header-anchor">#</a> PUSH相关</h2> <h3 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h3> <p>MB SDK实现逻辑：获取到设备的DeviceToken后，赋值给SDK实例对象。SDK会在合适的时机，例如成功建立连接，调用上传接口，将DeviceToken上传给MB服务器，以供后续PUSH功能使用。</p> <table><thead><tr><th>参数</th> <th>类型</th> <th>定义</th></tr></thead> <tbody><tr><td>deviceToken</td> <td>String</td> <td>设备id，推送功能的唯一标识符</td></tr></tbody></table> <h3 id="手动上传"><a href="#手动上传" class="header-anchor">#</a> 手动上传</h3> <p>MB SDK实现逻辑：除了自动上传，我们还提供了额外的上传接口，供业务方主动调用。</p> <h2 id="拓展知识"><a href="#拓展知识" class="header-anchor">#</a> 拓展知识</h2> <p>群组消息时序图：
<img src="/assets/img/send_logic.8f7d573b.svg" alt="发布消息时序图"></p> <h2 id="案例"><a href="#案例" class="header-anchor">#</a> 案例：</h2> <table><thead><tr><th>参数名</th> <th>参数值</th></tr></thead> <tbody><tr><td>appID</td> <td>56</td></tr> <tr><td>appKey</td> <td>c90265a583aaea81</td></tr> <tr><td>userId</td> <td>user_A</td></tr> <tr><td>userToken</td> <td>xxxxxx</td></tr> <tr><td>host</td> <td>54.205.75.48</td></tr> <tr><td>port</td> <td>443</td></tr></tbody></table> <h2 id="术语"><a href="#术语" class="header-anchor">#</a> 术语：</h2> <table><thead><tr><th>名称</th> <th>含义</th></tr></thead> <tbody><tr><td>MB</td> <td>Message Broker，消息总线</td></tr> <tr><td>IM</td> <td>Instance Messaging，即时通信</td></tr></tbody></table></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/document/general.html" class="prev">
        通用
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3182eedf.js" defer></script><script src="/assets/js/2.c3447483.js" defer></script><script src="/assets/js/6.140a8615.js" defer></script>
  </body>
</html>
